---
title: "Glacial area"
subtitle: "[NO_GLAC_001]"
format: 
  html:
    embed-resources: true
    code-fold: true
    toc: true
    toc-title: Contents
    toc-depth: 3
    smooth-scroll: true
execute: 
  cache: true
author:
  - name: Anders L. Kolstad
    email: anders.kolstad@nina.no
    affiliations:
      - id: myID
        name: Norwegian Institute for Nature Research 
date: March 5, 2025
callout-icon: false
lightbox: true
css: ../../../style.css
code-links:
      - text: Add a review
        icon: github
        href: https://github.com/NINAnor/ecRxiv
bibliography: references.bib
---

<!--# This is a template for how to document the indicator analyses. Make sure also to not change the order, or modify, the headers, unless you really need to. This is because it easier to read if all the indicators are presented using the same layout. If there is one header where you don't have anything to write, just leave the header as is, and don't write anything below it. If you are providing code, be careful to annotate and comment on every step in the analysis. Before starting it is recommended to fill in as much as you can in the metadata file. This file will populate the initial table in your output.-->

<!--# Load all you dependencies here -->

```{r setup}
#| include: false
library(knitr)
library(tidyverse)
library(kableExtra)
library(here)
library(sf)
knitr::opts_chunk$set(echo = TRUE)
path <- here::here("indicators/NO_GLAC_001")
```

```{r source}
#| echo: false
source(here::here("_common.R"))
```

```{r}
#| echo: false
meta <- readxl::read_xlsx("../metadata.xlsx")
st <- meta |>
  filter(Variable == "status") |>
  pull(Value)
version <- meta |>
  filter(Variable == "Version") |>
  pull(Value)
auth <- meta |>
  filter(Variable == "authors") |>
  pull(Value)
year <- meta |>
  filter(Variable == "yearAdded") |>
  pull(Value)
id <- meta |>
  filter(Variable == "indicatorID") |>
  pull(Value)
name <- meta |>
  filter(Variable == "indicatorName") |>
  pull(Value)
url <- meta |>
  filter(Variable == "url") |>
  pull(Value)

meta <- meta |>
  mutate(Variable = case_match(Variable,
    "indicatorID" ~ "Indicator ID" ,
    "indicatorName" ~ "Indicator Name",
    "country" ~ "Country",
    "continent" ~ "Continent",
    "ECT" ~ "Ecosystem Condition Typology Class",
    "yearAdded" ~ "Year added",
    "yearLastUpdate" ~ "Last update",
    .default = Variable
   )
  ) |>
  filter(Variable != "authors")

```

<!--# The following parts are autogenerated. Do not edit. -->

```{r}
#| echo: false
#| results: asis
status(st)
```

::: {layout-ncol="2"}
> **Recomended citation**: `r paste(auth, " ", year, ". ", name, " (ID: ", id, ") ", "v. ", version, ". ecRxiv: ", url, sep="")`

> **Version**: `r version`
:::

```{=html}
<details>
<summary>Show metadata</summary>
```

```{r tbl-meta}
#| tbl-cap: 'Indicator metadata'
#| echo: false
#| warning: false

meta |>
  select(Variable, Value) |>
  kbl(col.names = NULL) 

```

</details>

::: {.callout-tip collapse="true"}
## Logg

<!--# Update this logg with short messages for each update -->

-   01 Jan. 1901 - Original PR
:::

<hr />

<!--# Document you work below.  -->

## 1. Summary

```{=html}
<!--# 

With a maximum of 300 words, describe the indicator in general terms as you would to a non-expert. Think of this as a kind of commmon language summary. It is a good idea to include a bullet point list of the spesific steps in the workflow. Include a mention of the following aspects:

What does the metric represent?
Why is this relevant for describing ecosystem condition in this ecosystem?
What are the main anthropogenig impact factors?
What kind of data is used? 
Shortly, how is the data customized (modified, estimated, integarted) to fit its purpuse as an indicator?
What is the current status of  the metric (can it be used or is it still in development)?
How should the metric be used and interpretted, and how should it not be used/interpretted?

 -->
```

Glaciers represents both an important structural element in alpine ecosystems, providing melt water and local climate control. It is also a unique nature type in itself, with few, but very specialised, species living on or in association with the ice. Glaciers are permanently ice covered areas and they are sensitive to climate change, especially climate warming, which melts the ice. In Norway we have a rather detailed and precise map of the glacial extent from the period 1947-1985. Here we use this data as a representation of the climatic reference condition (pre climate warming), and compare the glacial extent with an update glacial extent map from 2018-2019 to create a normalised ecosystem condition indicator. The ecosystem assets are defined as intersections of bioclimatic regions and geographical regions. We have defined a threshold value (X~60~) as 10% remaining area, based on the assumption from Island Biogeography Theory that further loss of area will result in \>10% local species extinctions.

Indicator uncertainty originates from two sources. Firste we introduce a 3% error in the glacial estimates, based on the reported uncertainties in the mapping method. In practice we assign a probability distribution, rather than a point estimate, to each EA. We then resample the probability distributions for each EA 1000 times, creating 1000 estimates for the spatially aggregated indicator value. This introduces the second type of uncertainty, which is the spatial variation in indicator values across EAs.

The indicator is ready to be used. Future updates will require new maps of glacial extent in Norway, which is highly possible to produce from satellite imagery.

Interpretation: The indicator value represents the mean remaining glacial area across EAs.

Workflow

1.  Import glacial extent maps from two time periods

2.  Import delineations for bioclimatic regions and geographical regions and intersect to create strata (ecosystem assets, EA)

3.  Import alpine ecosystem mask

4.  Compile spatial dataset where each EA has data on strata category, glacial area at two time points and total mountain area.

5.  Add 3% uncertainty to glacial extent estimates

6.  Normalise variable at EA level by scaling, transforming and truncating.

7.  Resample within EAs and create a distribution of 1000 estimates of a spatially aggregate indicator value for geographical regions. Di this using two weighting schemes for comparison: weighted based on total mountain area or initial glacial area within each EA.

8.  Aggregate spatially from geographical region to national level, also using bootstrapping.

9.  Summarise national estimate and 50%CI in a table

## 2. About the underlying data

<!--# Describe the data you have used in more detail, it's origin, biases, availabilit ect.-->

### 2.1 Spatial and temporal resolution and extent

<!--# Describe the temporal and spatial resolution and extent of the data used -->

### 2.2 Original units

<!--# What are the original units for the most relevant  variables in the data-->

### 2.3 Additional comments about the dataset

<!--# Text here -->

#### 2.3.1 Instructions for citing, using and accessing data

<!--# Is the data openly available? If not, how can one access it? What are the key references to the datasets?   -->

The glaciel extent maps are distributed under CC-BY 4.0. We have made a simplified (less columns) version of the dataset available on github in order to make the workflow more reproducible.

## 3. Indicator properties

### 3.1 Ecosystem Condition Typology Class (ECT)

```{=html}
<!--# 

Describe the rationale for assigning the indicator to the ECT class. See https://oneecosystem.pensoft.net/article/58218/
This doesnt need to be very long. Maybe just a single sentence. 

-->
```

Area of glaciers is categorised as describing a C1 - Landscape and seascape characteristic. This put emphasis in the role of glaciers as a unique habitat type and a structural element in alpine ecosystems. The indicator has previously been attributed to A1 - Physical state characteristics due to the importance of melt water.

### 3.2 Ecosystem condition characteristic

```{=html}
<!--# 

Describe the ecosystem condition characteristic represented in the indicator. See 10.3897/oneeco.6.e58218 for information on what these characteristics might be.
For example, and indicator called 'Trenching in mires' could be made to represent an ecosystem characteristic 'Intact hydrology'. The term 'characteristic' is used similar to the term 'criteria' in Multiple Criteria Decition Making.  

-->
```

### 3.3 Other standards

<!--# Optional: Add text about other spesific standards, e.g. national standards, and how the indicator relates to these -->

### 3.4 Collinearities with other indicators

<!--# Describe known collinearities with other metrices (indicators or variables) that could become problematic if they were also included in the same Ecosystem Condition Assessment as the indicator described here. -->

### 3.5 Impact factors

<!--# Describe the main natural and anthropogenic factors that affecst the metric -->

## 4. Reference condition and levels

### 4.1 Reference condition

<!--# Define the reference condition (or refer to where it is defined). Note the destinction between reference condition and reference levels 10.3897/oneeco.5.e58216  -->

### 4.2 Reference levels

```{=html}
<!--# 

If relevant (i.e. if you have normalised a variable), describe the reference levels used to normalise the variable. 

Use the terminology where X~0~ referes to the referece level (the variable value) denoting the worst possible condition; X~100~denotes the optimum or best possible condition; and X~*n*~, where in is between 0 and 100, denotes any other anchoring points linking the variable scale to the indicator scale (e.g. the threshold value between good and bad condition X~60^). 

Why was the current option chosen and how were the reference levels quantified? If the reference values are calculated as part of the analyses further down, please repeat the main information here.

 -->
```

#### 4.2.1 Spatial resolution and validity

```{=html}
<!--# 

Describe the spatial resolution of the reference levels. E.g. is it defined as a fixed value for all areas, or does it vary. Also, at what spatial scale are the reference levels valid? For example, if the reference levels have a regional resolution (varies between regions), it might mean that it is only valid and correct to use for normalising local variable values that are first aggregated to regional scale. However, sometimes the reference levels are insensitive to this and can be used to scale variables at the local (e.g. plot) scale. 

 -->
```

## 5. Uncertainties

<!--# Describe the main uncertainties or sources of error in the indicator or the underlying data. -->

## 6. References

<!--# You can add references manually or use a citation manager and add intext citations as with crossreferencing and hyperlinks. See https://quarto.org/docs/authoring/footnotes-and-citations.html -->

## 7. Datasets

<!--# Describe the unique datasets seperately under seperate headers (Dataset A, Dataset B, etc.-->

### 7.1 Dataset A - Glacial extent 1947-1985

This data is based on a combination of landsat imagery and digitized topographic maps [@winsvold2014]. We use this map as our reference condition and assume this glacial extent represents the climatic period 1961-1990.

The dataset is manually downloaded.

URL: https://nve.brage.unit.no/nve-xmlui/handle/11250/2831053

```{r import1}
#| eval: false
#| code-summary: "Structure and cache data"
path1 <- paste0(path, "/data/cryoclim_GAO_NO_1947_1985_UTM_33N/cryoclim_GAO_NO_1947_1985_UTM_33N.shp")
dat_old <- sf::read_sf(path1) |>
  select(areal_km2)
saveRDS(dat_old, paste0(path, "/data/glacial_extent_old.rds"))
```

```{r readCache1}
#| code-summary: "Read data"
dat_old <- readRDS(paste0(path, "/data/glacial_extent_old.rds"))
```

### 7.2 Dataset B - Glacial extent 2018-2019

This is the map of glacial extent measured in ther period 2018-2019 [@andreassen2022].

URL: https://nve.brage.unit.no/nve-xmlui/handle/11250/2836926

```{r import2}
#| eval: false
#| code-summary: "Structure and cache data"
path2 <- paste0(path, "/data/GlacierAreaOutline_NO_2018_2019_N/GlacierAreaOutline_2018_2019_N.shp")

dat_new <- sf::read_sf(path2) |>
  select(areal_km2)
saveRDS(dat_new, paste0(path, "/data/glacial_extent_new.rds"))
```

```{r readCache2}
#| code-summary: "Read data"
dat_new <- readRDS(paste0(path, "/data/glacial_extent_new.rds"))
```

### 7.3 Dataset C - Geographical regions

Importing geographical regions.

```{r}
greg <- readRDS(paste0(path, "/data/regions.rds"))
```


### 7.4 Dataset D - Bioclimatic regions

Importing bioclimatic regions. The data licence is unknown, and even though a WMS service is publically available, I am not sure it is downloadable anywhere.

```{r}
#| eval: false

# file path to locally stored data
path3 <- "R:/GeoSpatialData/BiogeographicalRegions/Norway_PCA_klima/Original/20170614_Bioklima/20170614_Bioklima.gdb"

# read in the data and convert to tibbles for easy joins
soner <- sf::read_sf(path3, layer = "Soner2017") |> 
  as_tibble()

seksjoner <- sf::read_sf(path3, layer = "Seksjoner2017") |> 
  as_tibble()

# join based on SSB IDs and convert to sf object again
BCreg <- dplyr::left_join(soner , seksjoner |> select(-Shape), by = join_by(SSBID)) |>
  mutate(region = paste(Seksjon_ko, Sone_kode)) |>
  sf::st_as_sf() |>
  select(SSBID,
  Sone_kode,
  Sone_navn,
  Seksjon_ko,
  Seksjon_na,
  region) |>
  st_transform(st_crs(greg))

saveRDS(BCreg, paste0(path, "/data/bioclimatic_regions.rds"))
```

```{r}
# read cache
BCreg <- readRDS(paste0(path, "/data/bioclimatic_regions.rds"))
```

```{r fig-sonerOgSeksjoner}
#| fig-cap: "Distribution of area within each combination of bioclimatic sone and section (i.e. each bioclimatic region)."
BCreg |>
  ggplot(aes(x = Sone_kode, fill = region)) +
  geom_bar() +
  facet_grid(Seksjon_ko ~ Sone_kode, scales = "free") +
  guides(fill = "none") +
  theme(axis.text.x = element_blank(),
    axis.title.x.bottom = element_blank()) +
  labs(y = "km-2")
```

### 7.5 Dataset E - Alpine ecosystem extent

This extant map might be updated in the near future. I am not sure the origin of this map. 

```{r}
#| eval: false
pathE <- paste0(path, "/data/temp/alpine_extent.tif")

alpine <- stars::read_stars(pathE) |>
  st_as_sf(merge = T)
saveRDS(alpine, paste0(path, "/data/alpine_extent.rds"))
```

```{r}
alpine <- readRDS(paste0(path, "/data/alpine_extent.rds"))
```

### 7.6 Combined dataset
Next we need to create a dataset for the EAs. The EAs will be defined as the intersection between bioclimatic regions and geographical regions
```{r}
EA <- BCreg |>
  rename(BCreg = region) |>  
  sf::st_intersection(greg)

# create new variable for the unique EA IDs
EA <- EA |>
  mutate(EA = row_number())

# get mountain area for each EA 
alpine2 <- alpine |>
  st_intersection(EA) |>
  mutate(mountain_area = st_area())
```





## 8. Spatial units

```{=html}
<!--# 

Describe the spatial units that you rely on in your analyses. Highlight the spatial units (the resolution) that the indicator values should be interpretted at. Potential spatial delineation data should eb introduced under 7.1. Datasets. We recomend using the SEEA EA terminology opf Basic Spatial Units (BSU), Ecosystem Asses (EA) and Ecosystem Accounting Area (EAA). 

-->
```

## 9. Analyses

```{=html}
<!--# 

Use this header for documenting the analyses. Put code in seperate code chunks, and annotate the code in between using normal text (i.e. between the chunks, and try to avoid too many hashed out comments inside the code chunks). Add subheaders as needed. 

Code folding is activated, meaning the code will be hidden by default in the html (one can click to expand it).

Caching is also activated (from the top YAML), meaning that rendering to html will be quicker the second time you do it. This will create a folder inside you project folder (called INDICATORID_cache). Sometimes caching created problems because some operations are not rerun when they should be rerun. Try deleting the cash folder and try again.

-->
```

## 10. Results

```{=html}
<!--# 

Repeat the final results here. Typically this is a map or table of indicator values.

This is typically where people will harvest data from, so make sure to include all relevant output here, but don't clutter this section with too much output either.

-->
```

## 11. Export file

```{=html}
<!--# 

Optional: Display the code (don't execute it) or the workflow for exporting the indicator values to file. Ideally the indicator values are exported as a georeferenced shape or raster file with indicators values, reference values and errors. You can also chose to export the raw (un-normalised or unscaled variable) as a seperate product. You should not save large sptaial output data on GitHub. You can use eval=FALSE to avoid code from being executed (example below - delete if not relevant) 

-->
```

```{r export}
#| eval: false
```
